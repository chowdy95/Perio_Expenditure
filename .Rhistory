map_dfr(readRDS)
p <- df_results |>
mutate(n_sims = as.numeric(n_sims)) |>
arrange(Country, n_sims) |>
ggplot(aes(group = Country))
p +
geom_line(aes(x = n_sims, y = log(Mean_total_billions))) +
theme_minimal() +
scale_x_continuous(limits = c(1000, 12000), breaks = seq(1000, 12000, 1000))
library(tidyverse)
output_dir <- "convergence_tests"
# 1. Read all the saved RDS files into one dataframe
df_results <- list.files(
path = output_dir,
pattern = "\\.rds$",  # only RDS files
full.names = TRUE
) %>%
map_dfr(readRDS)  # combine all into one dataframe
# 2. Make sure n_sims is numeric (if not already)
df_results <- df_results %>%
mutate(n_sims = as.numeric(n_sims))
# 3. Plot log(total cost) vs number of simulations per country
ggplot(df_results, aes(x = n_sims, y = log(Mean_total_billions), group = Country)) +
geom_line(alpha = 0.7) +
theme_minimal() +
labs(
x = "Number of simulations",
y = "Log of mean total cost (US$ billions)",
title = "Convergence of Monte Carlo simulations by country"
) +
scale_x_continuous(limits = c(1000, 12000), breaks = seq(1000, 12000, 1000))
# ==============================================================================
# Convergence diagnostics (2050) — Region and Global aggregation
# ==============================================================================
rm(list = ls())
library(tidyverse)
library(countrycode)
# ------------------------------------------------------------------------------
# 1. Load simulation outputs from RDS files (no reruns)
# ------------------------------------------------------------------------------
output_dir <- "convergence_tests"
df_results <- list.files(
path = output_dir,
pattern = "\\.rds$",
full.names = TRUE
) %>%
map_dfr(readRDS) %>%
mutate(n_sims = as.numeric(n_sims))
# ------------------------------------------------------------------------------
# 2. Load GBD hierarchy
# ------------------------------------------------------------------------------
hier <- read_csv(
"data/GBD_location_hierarchy_wide.csv",
locale = locale(encoding = "Latin1")
) %>%
mutate(iso3c = countrycode(Country, "country.name", "iso3c")) %>%
select(Country, Region, Superregion)
# ------------------------------------------------------------------------------
# 3. Aggregate to Region level
# ------------------------------------------------------------------------------
region_results <- df_results %>%
left_join(hier, by = "Country") %>%
filter(!is.na(Region)) %>%
group_by(Region, n_sims) %>%
summarise(
Mean_total_billions = sum(Mean_total_billions, na.rm = TRUE),
.groups = "drop"
) %>%
mutate(Level = "Region")
# ------------------------------------------------------------------------------
# 4. Aggregate to Global level
# ------------------------------------------------------------------------------
global_results <- df_results %>%
group_by(n_sims) %>%
summarise(
Mean_total_billions = sum(Mean_total_billions, na.rm = TRUE),
.groups = "drop"
) %>%
mutate(
Region = "Global",
Level  = "Global"
)
# ------------------------------------------------------------------------------
# 5. Combine Region + Global
# ------------------------------------------------------------------------------
plot_data <- bind_rows(region_results, global_results)
# ------------------------------------------------------------------------------
# 6. Plot convergence (untransformed scale)
# ------------------------------------------------------------------------------
ggplot(plot_data,
aes(x = n_sims,
y = Mean_total_billions,
group = Region,
colour = Level)) +
geom_line(
data = filter(plot_data, Level == "Region"),
linewidth = 0.9,
alpha = 0.6
) +
geom_line(
data = filter(plot_data, Level == "Global"),
linewidth = 1.4
) +
theme_minimal() +
scale_x_continuous(
limits = c(1000, 12000),
breaks = seq(1000, 12000, 1000)
) +
labs(
title = "Convergence of Monte Carlo estimates by GBD region and globally (2050)",
x = "Number of simulations",
y = "Mean total dental expenditure (US$ billions)",
colour = NULL
)
# ==============================================================================
# Convergence diagnostics (2050) — Regions + Global (derived from regions)
# ==============================================================================
rm(list = ls())
library(tidyverse)
library(countrycode)
# ------------------------------------------------------------------------------
# 1. Load simulation outputs from RDS files
# ------------------------------------------------------------------------------
output_dir <- "convergence_tests"
df_results <- list.files(
path = output_dir,
pattern = "\\.rds$",
full.names = TRUE
) %>%
map_dfr(readRDS) %>%
mutate(n_sims = as.numeric(n_sims))
# ------------------------------------------------------------------------------
# 2. Load GBD hierarchy
# ------------------------------------------------------------------------------
hier <- read_csv(
"data/GBD_location_hierarchy_wide.csv",
locale = locale(encoding = "Latin1")
) %>%
mutate(iso3c = countrycode(Country, "country.name", "iso3c")) %>%
select(Country, Region)
# ------------------------------------------------------------------------------
# 3. Aggregate to Region level (single source of truth)
# ------------------------------------------------------------------------------
region_results <- df_results %>%
left_join(hier, by = "Country") %>%
filter(!is.na(Region)) %>%
group_by(Region, n_sims) %>%
summarise(
Mean_total_billions = sum(Mean_total_billions, na.rm = TRUE),
.groups = "drop"
)
# ------------------------------------------------------------------------------
# 4. Global = sum of Regions (NO re-aggregation from countries)
# ------------------------------------------------------------------------------
global_results <- region_results %>%
group_by(n_sims) %>%
summarise(
Mean_total_billions = sum(Mean_total_billions, na.rm = TRUE),
.groups = "drop"
) %>%
mutate(Region = "Global")
# ------------------------------------------------------------------------------
# 5. Combine for plotting
# ------------------------------------------------------------------------------
plot_data <- bind_rows(region_results, global_results)
# ------------------------------------------------------------------------------
# 6. Plot convergence (colour by Region)
# ------------------------------------------------------------------------------
ggplot(plot_data,
aes(x = n_sims,
y = Mean_total_billions,
colour = Region,
group = Region)) +
geom_line(
linewidth = 1,
alpha = if_else(plot_data$Region == "Global", 1, 0.6)
) +
theme_minimal() +
scale_x_continuous(
limits = c(1000, 12000),
breaks = seq(1000, 12000, 1000)
) +
labs(
title = "Convergence of Monte Carlo estimates by GBD region and globally (2050)",
x = "Number of simulations",
y = "Mean total dental expenditure (US$ billions)",
colour = "Region"
)
global_results <- region_results %>%
group_by(n_sims) %>%
summarise(
Mean_total_billions = sum(Mean_total_billions, na.rm = TRUE),
.groups = "drop"
) %>%
mutate(Region = "Global")
View(global_results)
View(region_results)
View(region_results)
# ==============================================================================
# Convergence diagnostics (2050) — Superregions only
# ==============================================================================
rm(list = ls())
library(tidyverse)
library(countrycode)
# ------------------------------------------------------------------------------
# 1. Load simulation outputs from RDS files
# ------------------------------------------------------------------------------
output_dir <- "convergence_tests"
df_results <- list.files(
path = output_dir,
pattern = "\\.rds$",
full.names = TRUE
) %>%
map_dfr(readRDS) %>%
mutate(n_sims = as.numeric(n_sims))
# ------------------------------------------------------------------------------
# 2. Load GBD hierarchy
# ------------------------------------------------------------------------------
hier <- read_csv(
"data/GBD_location_hierarchy_wide.csv",
locale = locale(encoding = "Latin1")
) %>%
mutate(iso3c = countrycode(Country, "country.name", "iso3c")) %>%
select(Country, Superregion)
# ------------------------------------------------------------------------------
# 3. Aggregate directly to Superregion
# ------------------------------------------------------------------------------
superregion_results <- df_results %>%
left_join(hier, by = "Country") %>%
filter(!is.na(Superregion)) %>%
group_by(Superregion, n_sims) %>%
summarise(
Mean_total_billions = sum(Mean_total_billions, na.rm = TRUE),
.groups = "drop"
)
# ------------------------------------------------------------------------------
# 4. Plot convergence (colour by Superregion)
# ------------------------------------------------------------------------------
ggplot(
superregion_results,
aes(
x = n_sims,
y = Mean_total_billions,
colour = Superregion,
group = Superregion
)
) +
geom_line(linewidth = 1, alpha = 0.8) +
theme_minimal() +
scale_x_continuous(
limits = c(1000, 12000),
breaks = seq(1000, 12000, 1000)
) +
labs(
title = "Convergence of Monte Carlo estimates by GBD superregion (2050)",
x = "Number of simulations",
y = "Mean total dental expenditure (US$ billions)",
colour = "Superregion"
)
# ==============================================================================
# Convergence diagnostics (2050) — Superregions only
# ==============================================================================
rm(list = ls())
library(tidyverse)
library(countrycode)
# ------------------------------------------------------------------------------
# 1. Load simulation outputs from RDS files
# ------------------------------------------------------------------------------
output_dir <- "convergence_tests"
df_results <- list.files(
path = output_dir,
pattern = "\\.rds$",
full.names = TRUE
) %>%
map_dfr(readRDS) %>%
mutate(n_sims = as.numeric(n_sims))
selected_model_df <- read_csv("outputs/final_selected_output.csv") %>%
select(Country, selected_model)
df_results <- list.files(
path = output_dir,
pattern = "\\.rds$",
full.names = TRUE
) %>%
map_dfr(readRDS) %>%
left_join(selected_model_df, by = "Country") %>%
filter(Scenario == selected_model) %>%
mutate(n_sims = as.numeric(n_sims))
rm(list = ls())
library(tidyverse)
library(countrycode)
output_dir <- "convergence_tests"
df_results <- list.files(
path = output_dir,
pattern = "\\.rds$",
full.names = TRUE
) %>%
map_dfr(readRDS) %>%
mutate(n_sims = as.numeric(n_sims))
selected_model_df <- read_csv("outputs/final_selected_output.csv") %>%
select(Country, selected_model)
df_results <- list.files(
path = output_dir,
pattern = "\\.rds$",
full.names = TRUE
) %>%
map_dfr(readRDS) %>%
left_join(selected_model_df, by = "Country") %>%
filter(Scenario == selected_model) %>%
mutate(n_sims = as.numeric(n_sims))
# ==============================================================================
# Convergence diagnostics (2050) — Superregions only
# ==============================================================================
rm(list = ls())
library(tidyverse)
library(countrycode)
# ------------------------------------------------------------------------------
# 1. Load simulation outputs from RDS files
# ------------------------------------------------------------------------------
output_dir <- "convergence_tests"
df_results <- list.files(
path = output_dir,
pattern = "\\.rds$",
full.names = TRUE
) %>%
map_dfr(readRDS) %>%
mutate(n_sims = as.numeric(n_sims))
# ------------------------------------------------------------------------------
# 2. Load GBD hierarchy
# ------------------------------------------------------------------------------
hier <- read_csv(
"data/GBD_location_hierarchy_wide.csv",
locale = locale(encoding = "Latin1")
) %>%
mutate(iso3c = countrycode(Country, "country.name", "iso3c")) %>%
select(Country, Superregion)
# ------------------------------------------------------------------------------
# 3. Aggregate directly to Superregion
# ------------------------------------------------------------------------------
superregion_results <- df_results %>%
left_join(hier, by = "Country") %>%
filter(!is.na(Superregion)) %>%
group_by(Superregion, n_sims) %>%
summarise(
Mean_total_billions = sum(Mean_total_billions, na.rm = TRUE),
.groups = "drop"
)
# ------------------------------------------------------------------------------
# 4. Plot convergence (colour by Superregion)
# ------------------------------------------------------------------------------
ggplot(
superregion_results,
aes(
x = n_sims,
y = Mean_total_billions,
colour = Superregion,
group = Superregion
)
) +
geom_line(linewidth = 1, alpha = 0.8) +
theme_minimal() +
scale_x_continuous(
limits = c(1000, 12000),
breaks = seq(1000, 12000, 1000)
) +
labs(
title = "Convergence of Monte Carlo estimates by GBD superregion (2050)",
x = "Number of simulations",
y = "Mean total dental expenditure (US$ billions)",
colour = "Superregion"
)
p2 <- ggplot(
superregion_results,
aes(
x = n_sims,
y = Mean_total_billions,
colour = Superregion,
group = Superregion
)
) +
geom_line(linewidth = 1, alpha = 0.8) +
theme_minimal() +
scale_x_continuous(
limits = c(1000, 12000),
breaks = seq(1000, 12000, 1000)
) +
labs(
title = "Convergence of Monte Carlo estimates by GBD superregion (2050)",
x = "Number of simulations",
y = "Mean total dental expenditure (US$ billions)",
colour = "Superregion"
)
ggsave(
"outputs/scatter_periodontal_vs_dental_SDI_continuous.pdf",
plot = p2,
width = 9,
height = 9,
dpi = 300
)
# Load libraries
library(tidyverse)
library(countrycode)
# Read datasets
country_totals <- read_csv("outputs/short_final_selected_output.csv")
sdi_data <- read_csv("data/GBD_SDI_quintiles.csv")
# Clean and standardize column names
sdi_data <- sdi_data %>%
rename(
Country = `Location Name`,
SDI = `2023 SDI Index Value`
)
# Add ISO codes for matching
country_totals <- country_totals %>%
mutate(iso3c = countrycode(Country, origin = "country.name", destination = "iso3c"))
sdi_data <- sdi_data %>%
mutate(iso3c = countrycode(Country, origin = "country.name", destination = "iso3c"))
# Merge and clean
merged_data <- country_totals %>%
left_join(sdi_data %>% select(iso3c, SDI), by = "iso3c") %>%
filter(!is.na(iso3c), !is.na(SDI))
# Calculate periodontitis expenditure per capita (USD)
merged_data <- merged_data %>%
mutate(perio_exppc_usd = (selected_Mean_total_billions * 1e9) / Pop)
p <- ggplot(merged_data, aes(
x = Dent_exppc_usd,
y = perio_exppc_usd,
color = selected_model,
size = SDI
)) +
geom_point(alpha = 0.5) +
scale_x_continuous(
labels = scales::comma_format(scale = 1, suffix = " USD"),
name = "Dental Expenditure per Capita"
) +
scale_y_continuous(
labels = scales::comma_format(scale = 1, suffix = " USD"),
name = "Periodontal Expenditure per Capita"
) +
scale_color_manual(
values = c(  "low"  = "#3182bd",
"mid"  = "#fed976",
"high" = "#de2d26"   ),
name = "Utilisation Scenario"
) +
scale_size_continuous(
range = c(0.1, 5),
name = "Socio-demographic Index (SDI)"
) +
theme_minimal(base_size = 13) +
theme(
panel.grid = element_blank(),
legend.position = "right",
axis.line = element_line(colour = "black", linewidth = 0.3),
axis.ticks = element_line(colour = "black", linewidth = 0.3),
axis.title = element_text(face = "bold"),
axis.text = element_text(color = "black"),
plot.margin = margin(10, 20, 10, 10)
)
#------------------------------------------------------------------------------------------
# Save output
#------------------------------------------------------------------------------------------
ggsave(
"outputs/scatter_periodontal_vs_dental_SDI_continuous.pdf",
plot = p,
width = 9,
height = 6,
dpi = 300
)
ggsave(
"outputs/convergence_plot_superregion.jpg",
plot = p2,
width = 9,
height = 9,
dpi = 300
)
ggsave(
"convergence_tests/convergence_plot_superregion.jpg",
plot = p2,
width = 9,
height = 9,
dpi = 300
)
p2 <- ggplot(
superregion_results,
aes(
x = n_sims,
y = Mean_total_billions,
colour = Superregion,
group = Superregion
)
) +
geom_line(linewidth = 1, alpha = 0.8) +
theme_minimal() +
scale_x_continuous(
limits = c(1000, 12000),
breaks = seq(1000, 12000, 1000)
) +
labs(
x = "Number of simulations",
y = "Mean total dental expenditure (US$ billions)",
colour = "Superregion"
)
ggsave(
"convergence_tests/convergence_plot_superregion.jpg",
plot = p2,
width = 9,
height = 9,
dpi = 300
)
perio_expenditure_wide <- read_csv("outputs_forecast/expenditure_summary_forecast_wide.csv") %>%
rename(location_name = LocationHeader) %>%
select(location_name, ends_with("2021") & contains ("selected"), ends_with("2050") & contains ("selected"), Region, Superregion, iso3c)
View(perio_expenditure_wide)
